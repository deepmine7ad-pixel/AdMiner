<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üñ•Ô∏è Miner (Firebase)</title>
<style>
body{background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial;padding:18px;max-width:720px;margin:auto}
button{padding:10px 14px;margin:6px;border-radius:8px;border:1px solid #333;cursor:pointer;font-weight:bold}
#startMine{background:#0f0;color:#000;}
#stopMine{background:#f00;color:#fff;}
header{display:flex;justify-content:space-between;align-items:center}
h1{margin:0 0 12px 0}.small{color:#aaa;font-size:0.9rem}
.note{color:#888;font-size:0.85rem;margin-top:8px}
</style>
</head>
<body>
<header>
  <h1>üñ•Ô∏è Miner</h1>
  <a href="wallet.html" style="color:#0f0;">Wallet</a>
</header>

<p class="small">Mining: <strong>+0.000003</strong> coins/sec for 9 hours. Ad boost stacks when active.</p>
<p>Status: <strong id="status">‚Äî</strong></p>
<p>Time left: <strong id="timeleft">‚Äî</strong></p>
<button id="startMine">Start Mining (9h)</button>
<button id="stopMine">Stop Mining</button>
<hr />
<p>Balance: üìÄ <strong id="balance">0.000000</strong></p>
<p class="note" id="signed">Connecting to Firebase‚Ä¶</p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ---------- FIREBASE CONFIG (your provided object) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCgqrZ-qSf1dYNNEdG3L1MePYr4CvNLAE8",
  authDomain: "adminer-341ae.firebaseapp.com",
  projectId: "adminer-341ae",
  storageBucket: "adminer-341ae.firebasestorage.app",
  messagingSenderId: "457130849493",
  appId: "1:457130849493:web:160485e9c436008bf0de5c",
  measurementId: "G-H9D4FW3BT4"
};
/* ----------------------------------------------------------- */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const MINING_RATE = 0.000003;       // per second
const BOOST_RATE = 0.00003;         // ad boost per second (stacks)
const MINING_DURATION_MS = 9 * 60 * 60 * 1000; // 9 hours

const statusEl = document.getElementById('status');
const timeEl = document.getElementById('timeleft');
const balanceEl = document.getElementById('balance');
const signedEl = document.getElementById('signed');

let uid = null;
let unsubSnapshot = null;

// Sign in anonymously
signInAnonymously(auth).catch(err => {
  signedEl.textContent = 'Firebase auth error: ' + err.message;
});

onAuthStateChanged(auth, async user => {
  if (!user) {
    signedEl.textContent = 'Not signed in';
    return;
  }
  uid = user.uid;
  signedEl.textContent = 'Signed in (anon). UID: ' + uid;
  await ensureUserDoc();
  listenUserDoc();
  startAutoTick(); // start background tick
});

async function ensureUserDoc(){
  const userRef = doc(db, 'users', uid);
  const snap = await getDoc(userRef);
  if (!snap.exists()){
    const now = Date.now();
    await setDoc(userRef, {
      device_id: 'dev-' + Math.random().toString(36).slice(2,11),
      wallet_balance: 0,
      last_update: now,
      mining_end: 0,
      boost_end: 0,
      last_ad_boost: 0,
      history: [],
      whole_milestones: []
    });
  }
}

// Listen for realtime updates and update UI
function listenUserDoc(){
  const userRef = doc(db, 'users', uid);
  if (unsubSnapshot) unsubSnapshot();
  unsubSnapshot = onSnapshot(userRef, snap => {
    if (!snap.exists()) return;
    const d = snap.data();
    balanceEl.textContent = (parseFloat(d.wallet_balance||0)).toFixed(6);
    const now = Date.now();
    if (now < (d.mining_end || 0)){
      statusEl.textContent = 'Mining';
      timeEl.textContent = msToHMS((d.mining_end||0) - now);
    } else {
      statusEl.textContent = 'Stopped';
      timeEl.textContent = '0s';
    }
  });
}

// Convert ms -> H M S
function msToHMS(ms){
  if (ms <= 0) return '0s';
  const s = Math.floor(ms/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return `${h}h ${m}m ${sec}s`;
}

// Periodic transactional tick: calculates elapsed time and credits mined amount
let tickInterval = null;
function startAutoTick(){
  if (tickInterval) return;
  tickInterval = setInterval(() => {
    transactionalTick().catch(e => console.error('tick err', e));
  }, 5000); // every 5 seconds
  // run once immediately
  transactionalTick().catch(e => console.error('tick err', e));
}

async function transactionalTick(){
  if (!uid) return;
  const userRef = doc(db, 'users', uid);
  await runTransaction(db, async (tx) => {
    const snap = await tx.get(userRef);
    if (!snap.exists()) throw new Error('user missing');
    const d = snap.data();
    const now = Date.now();
    const last = d.last_update || now;
    let elapsed = (now - last) / 1000.0;
    if (elapsed <= 0) {
      tx.update(userRef, { last_update: now });
      return;
    }
    let rate = 0;
    if (now < (d.mining_end || 0)) rate += MINING_RATE;
    if (now < (d.boost_end || 0)) rate += BOOST_RATE;
    const delta = rate * elapsed;
    const newBalance = (parseFloat(d.wallet_balance || 0) + delta);
    // append history entry
    const hist = (d.history || []).concat([{ t: now, added: Number(delta.toFixed(8)), reason: (now < (d.mining_end||0)?'mining':'') + (now < (d.boost_end||0)?'+adboost':'') }]);
    tx.update(userRef, { wallet_balance: newBalance, last_update: now, history: hist });
  });
}

// Start mining button
document.getElementById('startMine').addEventListener('click', async ()=>{
  if (!uid) return alert('Not signed in yet');
  const userRef = doc(db, 'users', uid);
  const now = Date.now();
  await updateDoc(userRef, { mining_end: now + MINING_DURATION_MS, last_update: now });
  // add a history entry client-side (transactionalTick will also log)
  // UI will update via onSnapshot
});

// Stop mining button
document.getElementById('stopMine').addEventListener('click', async ()=>{
  if (!uid) return alert('Not signed in yet');
  const userRef = doc(db, 'users', uid);
  const now = Date.now();
  await updateDoc(userRef, { mining_end: now, last_update: now });
});

// helper for updateDoc import
import { updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
</script>
</body>
</html>
